import{_ as s,c as i,a as n,o as e}from"./app-82cUmJ1Q.js";const p={};function l(d,a){return e(),i("div",null,[...a[0]||(a[0]=[n(`<h2 id="_1-环境信息" tabindex="-1"><a class="header-anchor" href="#_1-环境信息"><span>1. 环境信息</span></a></h2><ul><li><strong>设备机型</strong>：Android 16+, HyperOS</li><li><strong>高德地图版本</strong>：<code>com.amap.api:3dmap:9.8.3</code></li><li><strong>系统环境</strong>：Android 11 (API 30) 及以上 64 位设备</li></ul><h2 id="_2-错误堆栈分析" tabindex="-1"><a class="header-anchor" href="#_2-错误堆栈分析"><span>2. 错误堆栈分析</span></a></h2><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-text"><span class="line"><span>Abort message: &#39;Pointer tag for &lt;addr&gt; was truncated, see &#39;https://source.android.com/devices/tech/debug/tagged-pointers&#39;.&#39;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>      #00 pc 0000000000072d3c  /apex/com.android.runtime/lib64/bionic/libc.so (abort+156) (BuildId: ee2a16e13d7f3eb9da4980a5d1c3f92b)</span></span>
<span class="line"><span>      #01 pc 00000000000595a8  /apex/com.android.runtime/lib64/bionic/libc.so (free+104) (BuildId: ee2a16e13d7f3eb9da4980a5d1c3f92b)</span></span>
<span class="line"><span>      #02 pc 00000000007c0690  /data/app/~~kYkzfXCe00oHm0xfIput5Q==/com.dingli.thingsboard--JRuS9x6B2tqtpLsslb67Q==/base.apk!libAMapSDK_MAP_v9_8_3.so (offset 0x578000) (BuildId: 39f079b42910c63b85d73f04e316a5cc792e3970)</span></span>
<span class="line"><span>      #03 pc 00000000007bfff4  /data/app/~~kYkzfXCe00oHm0xfIput5Q==/com.dingli.thingsboard--JRuS9x6B2tqtpLsslb67Q==/base.apk!libAMapSDK_MAP_v9_8_3.so (offset 0x578000) (BuildId: 39f079b42910c63b85d73f04e316a5cc792e3970)</span></span>
<span class="line"><span>      #04 pc 00000000007ce7f4  /data/app/~~kYkzfXCe00oHm0xfIput5Q==/com.dingli.thingsboard--JRuS9x6B2tqtpLsslb67Q==/base.apk!libAMapSDK_MAP_v9_8_3.so (offset 0x578000) (BuildId: 39f079b42910c63b85d73f04e316a5cc792e3970)</span></span>
<span class="line"><span>      #05 pc 000000000040b8a4  /data/app/~~kYkzfXCe00oHm0xfIput5Q==/com.dingli.thingsboard--JRuS9x6B2tqtpLsslb67Q==/base.apk!libAMapSDK_MAP_v9_8_3.so (offset 0x578000) (BuildId: 39f079b42910c63b85d73f04e316a5cc792e3970)</span></span>
<span class="line"><span>      #06 pc 000000000038ca4c  /data/app/~~kYkzfXCe00oHm0xfIput5Q==/com.dingli.thingsboard--JRuS9x6B2tqtpLsslb67Q==/base.apk!libAMapSDK_MAP_v9_8_3.so (offset 0x578000) (BuildId: 39f079b42910c63b85d73f04e316a5cc792e3970)</span></span>
<span class="line"><span>      #07 pc 00000000003b0c14  /data/app/~~kYkzfXCe00oHm0xfIput5Q==/com.dingli.thingsboard--JRuS9x6B2tqtpLsslb67Q==/base.apk!libAMapSDK_MAP_v9_8_3.so (offset 0x578000) (BuildId: 39f079b42910c63b85d73f04e316a5cc792e3970)</span></span>
<span class="line"><span>      #08 pc 00000000003b06dc  /data/app/~~kYkzfXCe00oHm0xfIput5Q==/com.dingli.thingsboard--JRuS9x6B2tqtpLsslb67Q==/base.apk!libAMapSDK_MAP_v9_8_3.so (offset 0x578000) (BuildId: 39f079b42910c63b85d73f04e316a5cc792e3970)</span></span>
<span class="line"><span>      #09 pc 00000000003b0550  /data/app/~~kYkzfXCe00oHm0xfIput5Q==/com.dingli.thingsboard--JRuS9x6B2tqtpLsslb67Q==/base.apk!libAMapSDK_MAP_v9_8_3.so (offset 0x578000) (BuildId: 39f079b42910c63b85d73f04e316a5cc792e3970)</span></span>
<span class="line"><span>      #10 pc 0000000000371d0c  /data/app/~~kYkzfXCe00oHm0xfIput5Q==/com.dingli.thingsboard--JRuS9x6B2tqtpLsslb67Q==/base.apk!libAMapSDK_MAP_v9_8_3.so (offset 0x578000) (BuildId: 39f079b42910c63b85d73f04e316a5cc792e3970)</span></span>
<span class="line"><span>      #11 pc 00000000002a187c  /data/app/~~kYkzfXCe00oHm0xfIput5Q==/com.dingli.thingsboard--JRuS9x6B2tqtpLsslb67Q==/base.apk!libAMapSDK_MAP_v9_8_3.so (offset 0x578000) (BuildId: 39f079b42910c63b85d73f04e316a5cc792e3970)</span></span>
<span class="line"><span>      #12 pc 0000000000212b2c  /data/app/~~kYkzfXCe00oHm0xfIput5Q==/com.dingli.thingsboard--JRuS9x6B2tqtpLsslb67Q==/base.apk!libAMapSDK_MAP_v9_8_3.so (offset 0x578000) (BuildId: 39f079b42910c63b85d73f04e316a5cc792e3970)</span></span>
<span class="line"><span>      #13 pc 0000000000212dc4  /data/app/~~kYkzfXCe00oHm0xfIput5Q==/com.dingli.thingsboard--JRuS9x6B2tqtpLsslb67Q==/base.apk!libAMapSDK_MAP_v9_8_3.so (offset 0x578000) (BuildId: 39f079b42910c63b85d73f04e316a5cc792e3970)</span></span>
<span class="line"><span>      #14 pc 00000000001e74e8  /data/app/~~kYkzfXCe00oHm0xfIput5Q==/com.dingli.thingsboard--JRuS9x6B2tqtpLsslb67Q==/base.apk!libAMapSDK_MAP_v9_8_3.so (offset 0x578000) (BuildId: 39f079b42910c63b85d73f04e316a5cc792e3970)</span></span>
<span class="line"><span>      #15 pc 000000000018d8a4  /data/app/~~kYkzfXCe00oHm0xfIput5Q==/com.dingli.thingsboard--JRuS9x6B2tqtpLsslb67Q==/base.apk!libAMapSDK_MAP_v9_8_3.so (offset 0x578000) (BuildId: 39f079b42910c63b85d73f04e316a5cc792e3970)</span></span>
<span class="line"><span>      #16 pc 000000000011e724  /data/app/~~kYkzfXCe00oHm0xfIput5Q==/com.dingli.thingsboard--JRuS9x6B2tqtpLsslb67Q==/base.apk!libAMapSDK_MAP_v9_8_3.so (offset 0x578000) (Java_com_autonavi_base_ae_gmap_GLMapEngine_nativeDestroy+72) (BuildId: 39f079b42910c63b85d73f04e316a5cc792e3970)</span></span>
<span class="line"><span>      #17 pc 0000000000363e50  /system/framework/arm64/boot.oat (art_jni_trampoline+112) (BuildId: c7e7e6faa51bb8d9305dad9be682fdc7baeb097b)</span></span>
<span class="line"><span>      #18 pc 00000000006a8d8c  /apex/com.android.art/lib64/libart.so (nterp_helper+1948) (BuildId: b369ace762dbc30337aa79f5b81a8c15)</span></span>
<span class="line"><span>      #19 pc 00000000001fe800  /data/app/~~kYkzfXCe00oHm0xfIput5Q==/com.dingli.thingsboard--JRuS9x6B2tqtpLsslb67Q==/base.apk (offset 0x1000) (com.autonavi.base.ae.gmap.GLMapEngine.destroyAMapEngine+100)</span></span>
<span class="line"><span>      #20 pc 00000000006a9544  /apex/com.android.art/lib64/libart.so (nterp_helper+3924) (BuildId: b369ace762dbc30337aa79f5b81a8c15)</span></span>
<span class="line"><span>      #21 pc 00000000001b909c  /data/app/~~kYkzfXCe00oHm0xfIput5Q==/com.dingli.thingsboard--JRuS9x6B2tqtpLsslb67Q==/base.apk (offset 0x1000) (com.amap.api.col.3l.cb.destroySurface+104)</span></span>
<span class="line"><span>      #22 pc 00000000006a9544  /apex/com.android.art/lib64/libart.so (nterp_helper+3924) (BuildId: b369ace762dbc30337aa79f5b81a8c15)</span></span>
<span class="line"><span>      #23 pc 00000000001b31ee  /data/app/~~kYkzfXCe00oHm0xfIput5Q==/com.dingli.thingsboard--JRuS9x6B2tqtpLsslb67Q==/base.apk (offset 0x1000) (com.amap.api.col.3l.va.run+46)</span></span>
<span class="line"><span>      #24 pc 00000000006aa364  /apex/com.android.art/lib64/libart.so (nterp_helper+7540) (BuildId: b369ace762dbc30337aa79f5b81a8c15)</span></span>
<span class="line"><span>      #25 pc 0000000000238760  /system/framework/framework.jar (offset 0x124c000) (android.opengl.GLSurfaceView$GLThread.guardedRun+1460)</span></span>
<span class="line"><span>      #26 pc 00000000006a9544  /apex/com.android.art/lib64/libart.so (nterp_helper+3924) (BuildId: b369ace762dbc30337aa79f5b81a8c15)</span></span>
<span class="line"><span>      #27 pc 00000000002394fe  /system/framework/framework.jar (offset 0x124c000) (android.opengl.GLSurfaceView$GLThread.run+122)</span></span>
<span class="line"><span>      #28 pc 0000000000363f94  /apex/com.android.art/lib64/libart.so (art_quick_invoke_stub+612) (BuildId: b369ace762dbc30337aa79f5b81a8c15)</span></span>
<span class="line"><span>      #29 pc 000000000028fab8  /apex/com.android.art/lib64/libart.so (art::ArtMethod::Invoke(art::Thread*, unsigned int*, unsigned int, art::JValue*, char const*)+216) (BuildId: b369ace762dbc30337aa79f5b81a8c15)</span></span>
<span class="line"><span>      #30 pc 000000000048c6f4  /apex/com.android.art/lib64/libart.so (art::Thread::CreateCallback(void*)+1364) (BuildId: b369ace762dbc30337aa79f5b81a8c15)</span></span>
<span class="line"><span>      #31 pc 00000000000840fc  /apex/com.android.runtime/lib64/bionic/libc.so (__pthread_start(void*)+236) (BuildId: ee2a16e13d7f3eb9da4980a5d1c3f92b)</span></span>
<span class="line"><span>      #32 pc 0000000000076620  /apex/com.android.runtime/lib64/bionic/libc.so (__start_thread+64) (BuildId: ee2a16e13d7f3eb9da4980a5d1c3f92b)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="关键点提取" tabindex="-1"><a class="header-anchor" href="#关键点提取"><span>关键点提取</span></a></h3><ul><li><strong>错误信号</strong>：<code>Pointer tag was truncated</code>（指针标记被截断）。</li><li><strong>触发位置</strong>：在高德地图销毁引擎（<code>nativeDestroy</code>）并尝试调用底层 <code>free()</code> 释放内存时。</li><li><strong>直接诱因</strong>：Bionic 库检测到待释放内存指针的 <strong>Top-byte (高位字节)</strong> 标记被非法篡改或丢失。</li></ul><hr><h2 id="_3-核心原因深度解析" tabindex="-1"><a class="header-anchor" href="#_3-核心原因深度解析"><span>3. 核心原因深度解析</span></a></h2><h3 id="top-byte-ignore-tbi-与-tagged-pointers" tabindex="-1"><a class="header-anchor" href="#top-byte-ignore-tbi-与-tagged-pointers"><span>Top-byte Ignore (TBI) 与 Tagged Pointers</span></a></h3><p>从 <strong>Android 11</strong> 开始，针对 64 位 ARM 设备，系统默认开启了 <strong>Tagged Pointers</strong> 技术：</p><ol><li><strong>机制</strong>：系统利用 64 位指针中高 8 位（Top byte）存储特定的元数据（Tag），用于内存分配状态的追踪和安全校验。</li><li><strong>冲突</strong>：某些底层 SDK（如旧版高德地图 Native 库）在进行指针运算、位掩码处理或内存管理时，未能兼容这种带 Tag 的指针，导致高位字节被“截断”或清除。</li><li><strong>崩溃逻辑</strong>：当带 Tag 的内存被传递回 <code>free()</code> 函数时，系统校验发现指针不完整，为防止内存损坏（Memory Corruption），系统主动触发 <code>abort</code> 崩溃。</li></ol><hr><h2 id="_4-解决方案" tabindex="-1"><a class="header-anchor" href="#_4-解决方案"><span>4. 解决方案</span></a></h2><p>在 <code>AndroidManifest.xml</code> 中显式关闭 native 堆指针标记检查。这是目前解决第三方 SDK 兼容性问题最快速且有效的方法。</p><div class="language-xml line-numbers-mode" data-highlighter="shiki" data-ext="xml" style="--shiki-light:#393a34;--shiki-dark:#dbd7caee;--shiki-light-bg:#ffffff;--shiki-dark-bg:#121212;"><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code class="language-xml"><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">&lt;</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">application</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    ...</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">    android</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">allowNativeHeapPointerTagging</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">false</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">    &lt;/</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">application</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,15)])])}const c=s(p,[["render",l]]),r=JSON.parse('{"path":"/blog/86v2pqqw/","title":"故障笔记：高德地图 SDK 引起的 Tagged Pointers 内存崩溃","lang":"zh-CN","frontmatter":{"title":"故障笔记：高德地图 SDK 引起的 Tagged Pointers 内存崩溃","createTime":"2026/01/16 14:42:35","permalink":"/blog/86v2pqqw/"},"readingTime":{"minutes":2.63,"words":790},"git":{"createdTime":1768545982000,"updatedTime":1768546880000,"contributors":[{"name":"halifox","username":"halifox","email":"106858061+halifox@users.noreply.github.com","commits":3,"avatar":"https://avatars.githubusercontent.com/halifox?v=4","url":"https://github.com/halifox"}]},"filePathRelative":"blog/故障笔记：高德地图 SDK 引起的 Tagged Pointers 内存崩溃.md","headers":[],"categoryList":[]}');export{c as comp,r as data};
